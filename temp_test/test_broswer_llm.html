<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ì˜¤ë””ì˜¤/ì¸ì¦ í…ŒìŠ¤íŠ¸ (v3)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; color: #333; }
        .section { margin-bottom: 25px; }
        input[type="text"], input[type="password"], input[type="number"], select {
            width: calc(100% - 24px); padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
        }
        button {
            background-color: #007aff; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-right: 10px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; }
        #log {
            background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; height: 300px; overflow-y: scroll; font-family: 'Courier New', Courier, monospace; line-height: 1.5;
        }
        #log div { padding: 2px 0; }
        .status { padding: 10px; border-radius: 8px; margin-top: 10px; }
        .status-success { background-color: #e6f7ec; color: #2d6b46; }
        .status-error { background-color: #fdecea; color: #a5302f; }
        .dot { height: 12px; width: 12px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; }
        #recording-dot { background-color: #f44336; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="container">
        <h2>WebSocket ì˜¤ë””ì˜¤/ì¸ì¦ í…ŒìŠ¤íŠ¸ (v3)</h2>

        <!-- 0. ì¸ì¦ ì„¹ì…˜ (user_info í•„ë“œ ì¶”ê°€) -->
        <div class="section">
            <h3>0. ì¸ì¦ (Authentication)</h3>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <input type="text" id="name" placeholder="Name (ì˜ˆ: í™ê¸¸ë™)">
            <input type="number" id="age" placeholder="Age (ì˜ˆ: 30)">
            <input type="text" id="gender" placeholder="Gender (ì˜ˆ: male)">
            <button id="signupBtn">Sign Up (íšŒì›ê°€ì…)</button>
            <button id="loginBtn">Login (ë¡œê·¸ì¸)</button>
            <div id="authStatus" class="status" style="display:none;"></div>
        </div>

        <!-- 1. ì—°ê²° ì„¤ì • -->
        <div class="section">
            <h3>1. ì—°ê²° ì„¤ì • (Connection)</h3>
            <label for="jwt">JWT Token:</label>
            <input type="text" id="jwt" placeholder="ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.">
            
            <label for="scenario">Scenario:</label>
            <select id="scenario">
                <option value="institution_impersonation">ê¸°ê´€ ì‚¬ì¹­</option>
                <option value="loan_scam">ëŒ€ì¶œ ì‚¬ê¸°</option>
                <option value="friends_impersonation">ì§€ì¸ ì‚¬ì¹­</option>
                <option value="delivery_notification">ë°°ì†¡ ì•Œë¦¼ (í…ŒìŠ¤íŠ¸ìš©)</option>
            </select>
            
            <label for="mode">Mode:</label>
            <select id="mode">
                <option value="text">Text (í…ìŠ¤íŠ¸)</option>
                <option value="voice" selected>Voice (ìŒì„±)</option> <!-- ìŒì„± ëª¨ë“œ ê¸°ë³¸ ì„ íƒ -->
            </select>
            <br>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <!-- 2. í…ŒìŠ¤íŠ¸ -->
        <div class="section">
            <h3>2. í…ŒìŠ¤íŠ¸ (Test)</h3>
            <!-- í…ìŠ¤íŠ¸ ëª¨ë“œìš© -->
            <div id="text-controls" style="display:none;">
                <input type="text" id="message" placeholder="Send Text Message">
                <button id="sendTextBtn">Send Text</button>
            </div>
            
            <!-- ìŒì„± ëª¨ë“œìš© -->
            <div id="voice-controls" style="display:none;">
                <button id="startRecordingBtn">Start Recording (ë…¹ìŒ ì‹œì‘)</button>
                <button id="stopRecordingBtn" disabled>Stop Recording (ë…¹ìŒ ì¤‘ì§€)</button>
                <span id="recording-dot" class="dot" style="display:none;"></span>
                <input type="checkbox" id="streamMode" checked>
                <label for="streamMode">**ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ (í•„ìˆ˜)**</label>
            </div>
        </div>

        <!-- 3. ë¡œê·¸ -->
        <div class="section">
            <h3>3. ë¡œê·¸ (Log)</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const nameInput = document.getElementById('name'); // [ì¶”ê°€]
        const ageInput = document.getElementById('age'); // [ì¶”ê°€]
        const genderInput = document.getElementById('gender'); // [ì¶”ê°€]
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const authStatus = document.getElementById('authStatus');
        const jwtInput = document.getElementById('jwt');
        const scenarioSelect = document.getElementById('scenario');
        const modeSelect = document.getElementById('mode');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logEl = document.getElementById('log');

        const textControls = document.getElementById('text-controls');
        const messageInput = document.getElementById('message');
        const sendTextBtn = document.getElementById('sendTextBtn');

        const voiceControls = document.getElementById('voice-controls');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const recordingDot = document.getElementById('recording-dot');
        const streamModeCheckbox = document.getElementById('streamMode');

        let ws = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // --- 0. ì¸ì¦ ë¡œì§ ---

        function setAuthStatus(message, isError = false) {
            authStatus.textContent = message;
            authStatus.className = isError ? 'status status-error' : 'status status-success';
            authStatus.style.display = 'block';
        }

        // [ìˆ˜ì •] íšŒì›ê°€ì… ë¡œì§ (profile ê°ì²´ í¬í•¨)
        signupBtn.onclick = () => {
            const body = JSON.stringify({
                username: usernameInput.value,
                password: passwordInput.value,
                profile: {
                    name: nameInput.value,
                    age: parseInt(ageInput.value) || 0, // ìˆ«ìë¡œ ë³€í™˜
                    gender: genderInput.value
                }
            });

            console.log("Sending to /signup. Body:", body);

            fetch('http://localhost:8080/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    setAuthStatus(`Signup Error: ${data.error}`, true);
                } else {
                    setAuthStatus(`Signup Success: ${data.message}`, false);
                }
            })
            .catch(err => {
                setAuthStatus(`Fetch Error: ${err}`, true);
                console.error("Signup Fetch Error:", err);
            });
        };

        // ë¡œê·¸ì¸ ë¡œì§ (ë³€ê²½ ì—†ìŒ)
        loginBtn.onclick = () => {
            const body = JSON.stringify({
                username: usernameInput.value,
                password: passwordInput.value
            });

            console.log("Sending to /login. Body:", body);

            fetch('http://localhost:8080/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    setAuthStatus(`Login Error: ${data.error}`, true);
                } else if (data.token) {
                    setAuthStatus('Login Success! Token received.', false);
                    jwtInput.value = data.token;
                }
            })
            .catch(err => {
                setAuthStatus(`Fetch Error: ${err}`, true);
                console.error("Login Fetch Error:", err);
            });
        };

        // --- 1. WebSocket ì—°ê²° ë¡œì§ ---

        function logMessage(message, type = 'info') {
            const div = document.createElement('div');
            let prefix = '';
            if (type === 'sent') prefix = 'SENT ğŸ“¤: ';
            else if (type === 'received') prefix = 'RECV ğŸ“¥: ';
            else if (type === 'error') prefix = 'ERROR âŒ: ';
            
            div.innerHTML = `<span style="color: ${type === 'error' ? '#ff6b6b' : '#888'};">${new Date().toLocaleTimeString()}</span> ${prefix}${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        modeSelect.onchange = () => {
            if (modeSelect.value === 'text') {
                textControls.style.display = 'block';
                voiceControls.style.display = 'none';
            } else {
                textControls.style.display = 'none';
                voiceControls.style.display = 'block';
            }
        };
        modeSelect.onchange(); // ì´ˆê¸° ìƒíƒœ ì„¤ì •

        connectBtn.onclick = () => {
            const token = jwtInput.value;
            const scenario = scenarioSelect.value;
            const mode = modeSelect.value;

            if (!token) {
                logMessage('JWT Token is required!', 'error');
                return;
            }

            const url = `ws://localhost:8080/ws/simulation?token=${token}&scenario=${scenario}&mode=${mode}`;
            logMessage(`Connecting to ${url}...`);

            ws = new WebSocket(url);

            ws.onopen = () => {
                logMessage('Connected!', 'success');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            };

            ws.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    // [í•µì‹¬] STT->Gemini->TTSë¥¼ ê±°ì¹œ ì˜¤ë””ì˜¤ ì‘ë‹µ
                    logMessage(`Received Binary Blob: ${event.data.size} bytes`, 'received');
                    const audioUrl = URL.createObjectURL(event.data);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    // (ì´ˆê¸° ë©”ì‹œì§€ ë˜ëŠ” í…ìŠ¤íŠ¸ ëª¨ë“œ ì‘ë‹µ)
                    logMessage(event.data, 'received');
                }
            };

            ws.onerror = (error) => {
                logMessage('WebSocket Error. Check console (F12) for handshake failure details (e.g., 401, 400).', 'error');
                console.error('WebSocket Error:', error);
            };

            ws.onclose = (event) => {
                logMessage(`Disconnected. Code: ${event.code}, Reason: ${event.reason}`, 'info');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                ws = null;
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    stopRecording();
                }
            };
        };

        disconnectBtn.onclick = () => {
            if (ws) {
                ws.close();
            }
        };

        // --- 2. í…ìŠ¤íŠ¸ ëª¨ë“œ ---
        sendTextBtn.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = messageInput.value;
                ws.send(message);
                logMessage(message, 'sent');
                messageInput.value = '';
            } else {
                logMessage('Not connected.', 'error');
            }
        };
        messageInput.onkeydown = (e) => {
            if (e.key === 'Enter') sendTextBtn.onclick();
        };

        // --- 3. ìŒì„± ëª¨ë“œ (ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°) ---
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        // [ì¤‘ìš”] API ë¬¸ì„œì˜ ìš”êµ¬ì‚¬í•­(16kHz)ì— ë§ì¶”ê¸° ìœ„í•œ ì„¤ì •
                        // ë¸Œë¼ìš°ì €ê°€ ì§€ì›í•˜ì§€ ì•Šì„ ê²½ìš°, ê¸°ë³¸ê°’ìœ¼ë¡œ ë…¹ìŒë©ë‹ˆë‹¤.
                        // ì„œë²„ STTê°€ 16kHzë§Œ ë°›ëŠ”ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
                        sampleRate: 16000, 
                        channelCount: 1
                    } 
                });
                
                // [ì¤‘ìš”] 'audio/webm'ì´ ì•„ë‹Œ 'audio/opus'ë¥¼ ëª…ì‹œí•˜ì—¬
                // Linear16 PCMë³´ë‹¤ í›¨ì”¬ ê°€ë²¼ìš´ Opus ì½”ë±ìœ¼ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
                // Go ì„œë²„ì˜ STT APIëŠ” Opusë¥¼ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤ (Google STTëŠ” ì§€ì›í•¨).
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        // [í•µì‹¬] STT/Gemini í…ŒìŠ¤íŠ¸ëŠ” "ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°" ëª¨ë“œì—¬ì•¼ í•©ë‹ˆë‹¤.
                        if (streamModeCheckbox.checked) {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                ws.send(event.data); // ì²­í¬ë¥¼ ì¦‰ì‹œ ì „ì†¡
                                logMessage(`Sent audio chunk: ${event.data.size} bytes`, 'sent');
                            }
                        } else {
                            // (ë‹¨ì¼ íŒŒì¼ ëª¨ë“œ: í˜„ì¬ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
                            audioChunks.push(event.data);
                        }
                    }
                };

                mediaRecorder.onstop = () => {
                    if (!streamModeCheckbox.checked) {
                        // (ë‹¨ì¼ íŒŒì¼ ëª¨ë“œ: í˜„ì¬ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
                            ws.send(audioBlob);
//
                            logMessage(`Sent single audio file: ${audioBlob.size} bytes`, 'sent');
                        }
                    }
                    stream.getTracks().forEach(track => track.stop());
                };

                // 'ì‹¤ì‹œê°„' ëª¨ë“œì¼ ë•ŒëŠ” 1ì´ˆ(1000ms) ê°„ê²©ìœ¼ë¡œ ì²­í¬ ìƒì„±
                const timeslice = streamModeCheckbox.checked ? 1000 : undefined;
                mediaRecorder.start(timeslice);

                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                recordingDot.style.display = 'inline-block';
                logMessage('Recording started...', 'info');

            } catch (err) {
                logMessage('Error starting recording: ' + err.message, 'error');
                console.error(err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                recordingDot.style.display = 'none';
                logMessage('Recording stopped.', 'info');
            }
        }
        
        startRecordingBtn.onclick = startRecording;
        stopRecordingBtn.onclick = stopRecording;

    </script>
</body>
</html>